/*************************************************
**  jQuery Aligner 0.6
**  Copyright Jared Hardy, licensed MIT
**************************************************/
(function(a){a.fn.aligner=function(b){function o(a,b){localStorage.alignerBaselineColor=a;localStorage.alignerBaselineHeight=b}function n(a,b,c,d){localStorage.alignerGridColor=a;localStorage.alignerColumnCount=b;localStorage.alignerColumnWidth=c;localStorage.alignerGutterWidth=d}function m(b){var c,d,e;regX=/horz$/,numOfGuides=parseInt(localStorage["alignerGuidesCount"],10);b=[];for(var f=0;f<numOfGuides;f++){d=regX.test(localStorage["alignerGuide"+f+"Class"])?"horz":"vert";e=localStorage["alignerGuide"+f+"Style"];c=k(d,e);b.push(c);a("#guideCanvas").append(c)}return b}function l(b){localStorage.alignerGuidesCount=b.length;for(var c=0;c<b.length;c++){localStorage["alignerGuide"+c+"Class"]=a(b[c]).attr("class");localStorage["alignerGuide"+c+"Style"]=a(b[c]).attr("style")}}function k(b,c){var d=c?c:"";guide=a("<div />");if(c){d=c}else{if(b==="vert"){d="height: 100%; width: 2px; position: absolute; top: 20px; border-left: solid 1px "+e.guideColor+"; cursor: pointer;"}else if(b==="horz"){d="height: 2px; width: 100%; position: absolute; top: 20px; border-top: solid 1px "+e.guideColor+"; cursor: pointer;"}}guide.attr({"class":"alignerGuide "+b,style:d});return guide}function j(a){smallMark=5,mediumMark=10,largeMark=15;a=a*5;if(a%100===0){return largeMark}else if(a%25===0){return mediumMark}else{return smallMark}}var c=a(this[0]);var d={getOffset:function(a){return a.offset().left},drawGrid:function(b,c){e.gridColor=localStorage.getItem("alignerGridColor")===null?e.gridColor:localStorage.alignerGridColor;e.columns=localStorage.getItem("alignerColumnCount")===null?e.columns:parseInt(localStorage.alignerColumnCount,10);e.columnWidth=localStorage.getItem("alignerColumnWidth")===null?e.columnWidth:parseInt(localStorage.alignerColumnWidth,10);e.gutterWidth=localStorage.getItem("alignerGutterWidth")===null?e.gutterWidth:parseInt(localStorage.alignerGutterWidth,10);var d,f=e.columnWidth+e.gutterWidth,h=g.height;$gridCanvas=document.getElementById(b),fullWidth=(e.columnWidth+e.gutterWidth)*e.columns-e.gutterWidth;a($gridCanvas).attr({width:fullWidth,height:g.height});if($gridCanvas.getContext){var i=$gridCanvas.getContext("2d");i.clearRect(0,0,$gridCanvas.width,$gridCanvas.height);i.fillStyle=e.gridColor;for(d=0;d<e.columns;d++){i.fillRect(f*d,0,e.columnWidth,h)}}},drawBaseline:function(b){e.baselineHeight=localStorage.getItem("alignerBaselineHeight")===null?e.baselineHeight:parseInt(localStorage.alignerBaselineHeight,10);e.baselineColor=localStorage.getItem("alignerBaselineColor")===null?e.baselineColor:localStorage.alignerBaselineColor;var c,d=document.getElementById(b),f=e.baselineHeight;a(d).attr({width:g.width,height:g.height});if(d.getContext){var h=d.getContext("2d");h.clearRect(0,0,d.width,d.height);h.strokeStyle=e.baselineColor;h.lineWidth=1;for(var c=0;c<a(document).height();c+=f){h.beginPath();h.moveTo(0,c+f-.5);h.lineTo(d.width,c+f);h.stroke()}}},drawRulers:function(){e.guideColor=localStorage.getItem("alignerGuideColor")===null?e.guideColor:localStorage.alignerGuideColor;var b=document.getElementById("rulerCanvas"),c=a("#guideCanvas"),d,f,i,n=false,o=false,p=[],q,r=a("<div />").attr({id:"alignerPixelVert","class":"alignerPixelMarker"}),s=a("<div />").attr({id:"alignerPixelHorz","class":"alignerPixelMarker"});p=localStorage["alignerGuidesCount"]>0?m(p):[];a(b).attr({width:g.width,height:g.height});c.css({width:g.width,height:g.height});c.append(r).append(s);if(b.getContext){var t=b.getContext("2d");t.clearRect(0,0,b.width,b.height);t.fillStyle="rgba(255,255,255,0.8)";t.strokeStyle="#333";t.fillRect(20,0,g.width,20);t.fillRect(0,0,20,g.height);t.lineWidth=1;for(var u=2;u<g.width;u++){d=j(u);t.beginPath();t.moveTo(u*5,0);t.lineTo(u*5,d);t.stroke()}for(var v=2;v<g.height;v++){d=j(v);t.beginPath();t.moveTo(0,v*5);t.lineTo(d,v*5);t.stroke()}}a(".alignerGuide").live("mousedown",function(b){moveGuide=true;f=a(b.target)});c.bind({mousedown:function(b){q=b.pageY-a(window).scrollTop();if(b.pageX>20&&q<20&&!h){var c=k("horz");moveGuide=true;n=true;p.push(c);a("#guideCanvas").append(c)}if(b.pageX<20&&b.pageY>20&&!h){var c=k("vert");moveGuide=true;n=true;p.push(c);a("#guideCanvas").append(c)}a(window).bind("mousemove",function(b){i=n?a(p[p.length-1]):f;if(moveGuide&&!h){if(i.hasClass("horz")){b.preventDefault();s.show().css("top",b.pageY-s.outerHeight()/2).text(b.pageY+"px");i.css("top",b.pageY)}else{r.show().css("left",b.pageX-r.outerWidth()/2).text(b.pageX+"px");i.css("left",b.pageX)}}})},mouseup:function(b){n=false;moveGuide=false;if(i.hasClass("horz")){if(b.pageY<5){i.remove()}}else{if(b.pageX<5){i.remove()}}setTimeout(function(){a(".alignerPixelMarker").fadeOut()},500);a(window).unbind("mousemove");l(p)}})},addOptions:function(){var b='<div class="alignerGrids alignerPanel"><label for="aligner-number-of-columns">Number of Columns:</label><input type="text" id="aligner-number-of-columns"/><label for="aligner-column-width">Column Width:</label><input type="text"  id="aligner-column-width" /><label for="aligner-gutter-width">Gutter Width:</label><input type="text" id="aligner-gutter-width" /><label for="aligner-grid-color">Column Color:</label><input type="text" id="aligner-grid-color" /> <button id="aligner-update-grid" class="alignerButton">Update Grid</button><button id="aligner-clear-grid" class="alignerClearSettings alignerButton">Clear Settings</button></div>',c='<div class="alignerBaseline alignerPanel"><label for="aligner-baseline">Baseline Height:</label><input type="text" id="aligner-baseline" /><label for="aligner-baseline-color">Baseline Color:</label><input type="text" id="aligner-baseline-color" /><button id="aligner-udpate-baseline" class="alignerButton">Update Baseline</button><button id="aligner-clear-baseline" class="alignerClearSettings alignerButton">Clear Settings</button></div>',d='<div class="alignerGuides alignerPanel"><label for="aligner-guide-color">Guide Color:</label><input type="text" id="aligner-guides-color" /><div class="alignerCheckbox"><label for="aligner-lock-guides">Lock Guides</label><input type="checkbox" id="aligner-lock-guides"></div><div class="alignerCheckbox"><label for="aligner-guides-responsive">Responsive Guides <br/>(to do)</label><input type="checkbox" id="aligner-guides-responsive /"></div><button id="aligner-update-guides" class="alignerButton">Update Guides</button><button id="aligner-clear-guides" class="alignerClearSettings alignerButton">Clear Settings</button></div>',e='<div id="alignerOptionsPanels"><div id="alignerOptionsHeader"><ul><li class="activeTab">Grid</li><li>Rulers & Guides</li><li>Baseline</li></ul><div id="alignerPanelsClose">x</div></div>'+b+d+c+"</div>";a("body").append(e);var f=a(".alignerPanel"),g=a("#alignerOptionsPanels"),h=g.find("li"),i={};h.click(function(b){h.removeClass("activeTab");var c=a(b.target);f.hide();c.addClass("activeTab");a(f[c.index()]).show()});a("#alignerPanelsClose").click(function(){g.hide()});a("#alignerOptionsHeader").bind({mousedown:function(b){i.x=b.pageX-g.offset().left;i.y=b.pageY-g.offset().top;a(window).bind("mousemove",function(a){g.css({top:a.pageY-i.y,left:a.pageX-i.x})})},mouseup:function(){a(window).unbind("mousemove")}})},optionListeners:function(){var b=a("#aligner-number-of-columns"),c=a("#aligner-column-width"),f=a("#aligner-gutter-width"),g=a("#aligner-grid-color"),i=a("#aligner-baseline"),j=a("#aligner-baseline-color"),k=a("#aligner-guides-responsive"),l=a("#aligner-lock-guides"),m=a("#aligner-guides-color"),p=a(".alignerClearSettings");b.val(e.columns);c.val(e.columnWidth);f.val(e.gutterWidth);g.val(e.gridColor);i.val(e.baselineHeight);j.val(e.baselineColor);m.val(e.guideColor);a("#aligner-update-grid").click(function(){e.columns=parseInt(b.val(),10);e.columnWidth=parseInt(c.val(),10);e.gutterWidth=parseInt(f.val(),10);e.gridColor=g.val();n(e.gridColor,e.columns,e.columnWidth,e.gutterWidth);d.drawGrid("gridCanvas")});a("#aligner-udpate-baseline").click(function(){e.baselineHeight=parseInt(i.val(),10);e.baselineColor=j.val();o(e.baselineColor,e.baselineHeight);d.drawBaseline("baselineCanvas")});a("#aligner-lock-guides").change(function(){h=h?false:true});a("#aligner-update-guides").click(function(){e.guideColor=m.val();localStorage.alignerGuideColor=e.guideColor;a(".alignerGuide").css("border-top","solid 1px "+e.guideColor)});p.click(function(){localStorage.clear();a(".alignerGuide").remove()})},resize:function(b){f={height:a(window).height(),width:a(window).width()};a("#gridCanvas").css("left",b);d.drawBaseline("baselineCanvas");d.drawRulers()},setUp:function(b,c,e){var f=a("<canvas />").attr({id:"gridCanvas",style:"position: absolute; top: 0; left: 0; display: none;"}),g=a("<canvas />").attr({id:"baselineCanvas",style:"position: absolute; top: 0; left: 0; display: none;"}),h=a("<canvas />").attr({id:"rulerCanvas",style:"position: fixed; top: 0; left: 0; display: none;"}),i=a("<div />").attr({id:"guideCanvas",style:"position: absolute; top: 0; left: 0; display: none;"});alignerOptions=a("<div />").attr({id:"alignerOptions"});a("body").append(f).append(g).append(h).append(i).append(alignerOptions);d.drawGrid(b);d.resize(e);d.drawBaseline(c);d.drawRulers();d.addOptions();d.optionListeners()},init:function(a){d.setUp("gridCanvas","baselineCanvas",d.getOffset(a))}};var e=a.extend({},a.fn.aligner.defaults,b),f={height:a(window).height(),width:a(window).width()},g={height:a(document).height(),width:a(document).width()},c=a(this[0]),h=false,i;a("*").live({focus:function(){i=true},blur:function(){i=false}});a(document).keypress(function(b){if(i){return}else{if(b.which===103){a("#gridCanvas").toggle()}if(b.which===98){a("#baselineCanvas").toggle()}if(b.which===114){a("#rulerCanvas").toggle();a("#guideCanvas").toggle()}if(b.which===97){a("#alignerOptionsPanels").toggle()}if(b.which===108){h=h?false:true}}});a(window).bind("resize",function(){f={height:a(window).height(),width:a(window).width()};g={height:a(document).height(),width:a(document).width()};d.resize(d.getOffset(c))});return d.init(a(this[0]))};a.fn.aligner.defaults={columnWidth:60,gutterWidth:20,columns:12,baselineHeight:16,gridColor:"rgba(255, 0, 0, 0.3)",baselineColor:"rgba(255, 0, 0, 1)",guideColor:"#6afeff"}})(jQuery)